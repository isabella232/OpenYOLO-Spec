# Operations

OpenYOLO defines four core operations:

- _hint retrieval_: Provides basic account information to help create a new
  account.
- _credential retrieval_: Provides access to an existing stored credential for
  the requesting service.
- _credential saving_: Allows a service to store or update a credential in
  a credential provider.
- _credential deletion_: Allows a service to delete a credential which is no
  longer valid.

A provider MAY implement any subset of these operations; none are required.
Each operation is described in more detail in the following sections.

## Hint retrieval

When an service wants to create a new account for the user, they typically
need the following core pieces of information:

- The _authentication method_ that the user prefers to use, drawn from the
  set that the service supports. For instance, a service might allow a user
  to create an account with a phone number, Google Sign-in or Facebook
  Sign-in. If a non-federated authentication method is used, a
  _generated password_ that conforms to the service's password restrictions
  is desirable.

- A unique _identifier_ for the account, which is typically an email address,
  or phone number that would also be used for account recovery. For many
  services, proof of access to this identifier is crucial, and so
  an ID token is also desired to avoid an out-of-context verification.

- A _display name_ and _profile picture_ for the user, in order to personalize
  the service. Where it is possible for a user to have multiple accounts with
  the service, the display name and profile picture help the user to
  distinguish between these accounts.

The OpenYOLO _hint retrieval_ operation allows a service to request this
information from the credential provider. In response, the credential provider
is expected to present a choice of the user's commonly-used identifiers or
federated credentials, enabling a "single tap" account creation experience.
After selection, the provider might return a Credential object representing
the user's selection, optionally including a generated password or ID token
if applicable. A hint MUST NOT be returned automatically by a credential
provider - user interaction is strictly required before any personally
identifying information is returned.

Where a proof of access ID token is desired, a service MUST declare the
_token providers_ that is supports. Additionally, for each supported token
provider, a _client ID_ MAY be required. This is typically a value
generated by the token provider during registration as an OAuth2 client.
Finally, a _nonce_ can be provided that will be included in any generated
ID token, as a protection against replay attacks. Non-standard properties
specific to each token provider MAY be specified via an additional properties
map.

### Hint request message

A hint retrieval request is represented by the following protocol buffer
message:

```protobuf
message HintRetrieveRequest {
    ClientVersion client_version = 1;

    // at least one authMethod required
    repeated AuthenticationMethod auth_methods = 2;

    PasswordSpecification password_spec = 3;
    map<string, TokenRequestInfo> supported_token_providers = 4;
    map<string, bytes> additional_props = 5;
}

message TokenRequestInfo {
    string client_id = 1;
    string nonce = 2;
    map<string, bytes> additional_props = 3;
}
```

A simple hint request could then look like the following:

```json
{
  "auth_methods": [
    "openyolo://email",
    "https://accounts.google.com",
    "https://www.facebook.com"
  ]
}
```

This indicates that the service supports email and password based
authentication, Google Sign-in and Facebook Sign-in. The service has not
declared a password specification, therefore the OpenYOLO default specification
SHOULD be used by the credential provider if necessary. No supported token
providers have been specified, therefore no ID token is desired.

A more complex request, with a custom password specification and two supported
token provider could look like:

```json
{
  "auth_methods": [
    "openyolo://email"
  ],
  "password_spec": {
    "allowed": "0123456789",
    "min_size": 6,
    "max_size": 6
  },
  "supported_token_providers": {
    "https://accounts.google.com": {
      "client_id": "CLIENT.apps.googleusercontent.com",
      "nonce": "asdf123"
    },
    "https://auth.example.com": {
      "client_id": "11451",
      "nonce": "asdf123"
    }
  }
}
```

### Hint response message

A hint retrieval response is represented by the following protocol buffer
message:

```protobuf
message HintRetrieveResult {
  enum ResultCode {
    UNSPECIFIED = 0;
    BAD_REQUEST = 1;
    HINT_SELECTED = 2;
    NO_HINTS_AVAILABLE = 3;
    USER_REQUESTS_MANUAL_AUTH = 4;
    USER_CANCELED = 5;
  }

  // required
  ResultCode result_code = 1;

  Hint hint = 2;
  map<string, bytes> additional_props = 3;
}
```

The result codes are defined as follows:

- `UNSPECIFIED`: The generic catch-all for a request failure. This SHOULD NOT
  be used by providers, unless the other defined response codes do not apply.

- `BAD_REQUEST`: The request sent by the client was malformed or violated some
  security constraint enforced by the provider. This error should be treated
  as permanent; repeating the exact same request should result in the same
  error code response.

- `HINT_SELECTED`: The user selected a hint, which has been returned in the
  hint field of the message.

- `NO_HINTS_AVAILABLE`: No hints are available that match the constraints of the
  request.

- `USER_REQUESTS_MANUAL_AUTH`: The user canceled the selection of a hint in
  a manner that indicates they wish to proceed with authentication, but by
  manually entering their details. Providers SHOULD return this code
  if they display an option like "none of the above" or "use different account"
  and the user selects it.

- `USER_CANCELED`: The user canceled the selection of a hint in a manner that
  indicates they do not wish to authenticate at this time. Providers SHOULD
  return this code if:
  - The user presses the back button on their device
  - The user clicks outside the control area of a modal dialog
  - The user chooses some explicit option like "not now".

An email and password credential hint that could be returned for a requesting
app "com.example.app" could be:

```json
{
  "result_code": "HINT_SELECTED",
  "hint": {
    "id": "jblack@example.com",
    "auth_method": "openyolo://email",
    "display_name": "Jack Black",
    "display_picture_uri": "https://www.robohash.org/dcd65581?set=3",
    "generated_password": "YjW5Zvn3Fc7fY",
    "id_token":
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpX
        VCJ9.eyJzdWIiOiJqZG9lQGdtYWlsLmNv
        bSIsImF1ZCI6Imh0dHBzOi8vbG9naW4uZ
        XhhbXBsZS5jb20iLCJpc3MiOiJodHRwcz
        ovL2F1dGguZXhhbXBsZS5jb20iLCJuYW1
        lIjoiSmFuZSBEb2UifQ.CibuoaNMO-2pR
        QjWUbJMpMLWjKB34AMWCR4pIWD5tnE"
  }
}
```

Alternatively, a federated credential hint for Google Sign-in might look like:

```json
{
  "result_code": "HINT_SELECTED",
  "hint": {
    "id": "jdoe@gmail.com",
    "auth_method": "https://accounts.google.com",
    "display_name": "John Doe"
  }
}
```

### Example hint retrieval scenario

Jane Doe is visiting the travel site `https://adventures.example.com` for the
first time. Upon first page load, the site attempts to retrieve an existing
credential using OpenYOLO, but nothing is saved so it does not interrupt
Jane's flow further at this point.

After browsing a few travel packages, Jane notices a button with
label "save for later", and decides to press it. The service navigates to
an account creation screen, explaining that an account must be created to
save the package. At this point, the service sends a hint retrieval request,
and a hint selector dialog is presented:

```
+------------------------------------+
|                              +---+ |
| Continue With:               | X | |
|                              +---+ |
| +--------------------------------+ |
|                                    |
|  +---+ Jane Doe                    |
|  | O |                             |
|  |/_\| jdoe@gmail.com              |
|  +---+                             |
|        (with generated password)   |
|                                    |
| +--------------------------------+ |
|                                    |
|  +---+ John Doe                    |
|  | O |                             |
|  |/_\| john@example.com            |
|  +---+                             |
|        (with generated password)   |
|                                    |
| +--------------------------------+ |
|                                    |
|  +---+ Jill Doe                    |
|  | O |                             |
+--+---+-----------------------------+
```

Jane selects her most commonly used email address; a password is generated and
a credential returned to the service, and the provider is able to produce
an ID token for the selected email address.

The service utilizes the returned hint to bootstrap the new account, and after
successfully creating the account requests that the credential provider
save the credential. As the credential has not been modified by the site
from the details in the returned hint, it saves the credential automatically.

From Jane's perspective, this all happens from a single click on an account
in a presented dialog. She is now signed in, and the travel package she
selected is now saved to her account so she can return to it later.

## Credential retrieval

Where an existing credential is known for a service, it is often beneficial to
the service and the user for that credential to be retrieved and used for
authentication as early as possible. This allows the service to be appropriately
personalized to the user, such as providing shopping recommendations based on
past purchases. This SHOULD, of course, respect the user's preferences, as
there are many legitimate use cases where a user might wish to browse a service
in a signed-out state.

### Credential request message

A credential retrieval request is represented by the following protocol
buffer message:

```protobuf
message CredentialRetrieveRequest {
    ClientVersion client_version = 1;

    // at least one authMethod required
    repeated AuthenticationMethod auth_methods = 2;

    map<string, TokenRequestInfo> supported_token_providers = 3;
    bool require_user_mediation = 4;
    map<string, bytes> additional_props = 5;
}
```

The service lists the authentication methods that it supports, which are used
to filter the set of credentials that are stored by the credential provider.
Similar to hint requests, the service can also specify its supported token
providers - the return of a valid ID token can provide an additional signal
to the service that this login attempt is legitimate.

To prevent automatic sign-in loops, where a user signs out and is
inadvertently signed back in again automatically by a credential retrieve
request, the `require_user_mediation` flag can be set to true. If absent
from the request message, this is assumed to be false. When true, and
one or more credentials are available, the provider MUST require an explicit
credential selection from the user, even if only one option is available. This
then gives the user the opportunity to more clearly state their intent in an
account-switch scenario, by rejecting the presented credential and entering an
account creation or manual sign-in flow.

In response to a credential request, the credential provider can either:

- directly return a credential for automatic sign-in
- Show a credential picker to the user
- Return a failure result code if no matching credentials are available.

Automatically returning a credential is optional, and if it is a facility
provided by the credential provider, SHOULD be something that the user can
disable. A credential SHOULD NOT be returned by a provider unless it
believes that the credential is a valid, existing credential for the requesting
service.

An example credential retrieval request could look like:

```json
{
  "auth_methods": [
    "openyolo://phone",
    "https://www.facebook.com"
  ]
}
```

### Credential response message

The response to a credential request is represented by the following protocol
buffer message:

```protobuf
message CredentialRetrieveResult {
  enum ResultCode {
    UNSPECIFIED = 0;
    BAD_REQUEST = 1;
    CREDENTIAL_SELECTED = 2;
    NO_CREDENTIALS_AVAILABLE = 3;
    USER_REQUESTS_MANUAL_AUTH = 4;
    CANCEL_AUTH = 5;
  }

  // required
  ResultCode result_code = 1;

  Credential credential = 2;
  map<string, bytes> additional_props = 3;
}
```

The result codes are defined as follows:

- `UNSPECIFIED`: The generic catch-all for a request failure. This SHOULD NOT
  be used by providers, unless the other defined response codes do not apply.

- `BAD_REQUEST`: The request sent by the client was malformed or violated some
  security constraint enforced by the provider. This error should be treated
  as permanent; repeating the exact same request should result in the same
  error code response.

- `CREDENTIAL_SELECTED`: The user selected a hint, which has been returned in
  the hint field of the message.

- `NO_CREDENTIALS_AVAILABLE`: No credentials are available that match the
  constraints of the request.

- `USER_REQUESTS_MANUAL_AUTH`: The user canceled the selection of a hint in
  a manner that indicates they wish to proceed with authentication, but by
  manually entering their details. Providers SHOULD return this code
  if they display an option like "none of the above" or "use different account"
  and the user selects it.

- `USER_CANCELED`: The user canceled the selection of a hint in a manner that
  indicates they do not wish to authenticate at this time. Providers SHOULD
  return this code if:
  - The user presses the back button on their device
  - The user clicks outside the control area of a modal dialog
  - The user chooses some explicit option like "not now".


An example response could therefore look like:

```json
{
  "result_code": "CREDENTIAL_SELECTED",
  "credential": {
    "id": "jdoe",
    "auth_domain": "https://login.example.com",
    "auth_method": "https://www.facebook.com"
  }
}
```

Or, if the user was presented a list of credentials and did not select one:

```json
{
  "result_code": "USER_CANCELED"
}
```

### Example credential retrieval scenario

Jane has just bought a new phone and has just installed the "TechNews" app.
When she opens the app, it immediately sends a credential retrieval request
for email, Google and Facebook stored credentials. Jane frequently used
TechNews on her old phone and had saved his email address and password with
her credential provider. Her credential provider receives the request, and
automatically returns the saved credential to the TechNews app and displays
a notification that it has done so. The TechNews app uses the credential to
sign in, and shows Jane her personalized feed of news.

## Credential saving

Once a user has created an account or successfully signed in using an existing
account, it is beneficial to them for this credential to be saved to their
credential provider. This ensures that when the user changes device, or their
session is invalidated, re-authentication is simplified through the use
of the credential retrieval operation.

In the case where a service saves a credential that is already known, this is
still a useful signal to the credential provider that the saved data is
accurate. Where discrepancies are detected, such as a change in password, this
provides an opportunity to confirm and update the saved data. Credential
providers MAY allow automatic saving of credentials, but it is recommended
to seek explicit confirmation from the user where the credential data is
new or sensitive (i.e. contains a previously unseen identifier or password).

How this confirmation is solicited from the user is outside the scope of this
specification; the reference implementation uses the following confirmation
dialog style design:

```
+------------------------------------+
|                                    |
| Save your password for ExampleApp  |
|         to ExampleProvider?        |
|                                    |
|    +----+ +--------------------+   |
|    | OK | | Never for this app |   |
|    +----+ +--------------------+   |
|                                    |
+------------------------------------+
```

### Save request message

A save credential request is represented by the following protocol buffer
message:

```protobuf
message CredentialSaveRequest {
    ClientVersion client_version = 1;

    // required
    Credential credential = 2;

    map<string, bytes> additional_props = 3;
}
```

### Save response message

```protobuf
message CredentialSaveResult {

  enum ResultCode {
    UNSPECIFIED = 0;
    BAD_REQUEST = 1;
    SAVED = 2;
    PROVIDER_REFUSED = 3;
    USER_CANCELED = 4;
    USER_REFUSED = 5;
  }

  // required
  ResultCode result_code = 1;

  map<string, bytes> additional_props = 2;
}
```

The result codes are defined as follows:

- `UNSPECIFIED`: The generic catch-all for a request failure. This SHOULD NOT
  be used by providers, unless the other defined response codes do not apply.

- `BAD_REQUEST`: The request sent by the client was malformed or violated some
  security constraint enforced by the provider. This error should be treated
  as permanent; repeating the exact same request should result in the same
  error code response.

- `SAVED`: The credential was saved, or an equivalent credential was updated.

- `PROVIDER_REFUSED`: The provider refused to save the credential, due to
  some policy restriction. For example, a provider may refuse to update an
  existing credential if it is stored in a shared keychain. The client
  SHOULD NOT request to save this credential again.

- `USER_CANCELED`: The user dismissed the request to save the credential,
  by either pressing the back button, clicking outside the area of a modal
  dialog, or some other "soft" cancelation that is not an explicit refusal
  to delete the credential. The client MAY request to save this credential
  again at a later time.

- `USER_REFUSED`: The user refused the request to save this credential. The
  client SHOULD NOT request to save this credential again.

## Credential deletion

Stale credentials stored in a credential provider are a source of frustration
for users. Stale credentials are particularly common in browsers that rely on
heuristics to detect password changes and update saved credentials.

When a credential is stale, it only serves as a barrier to
authentication. In most cases, the user will be forced to perform a tedious account recovery process, and if they do not remember to manually delete the
stale credential, will likely be faced with the same issue again in the future.

In order to provide services a way to flag stale credentials to a provider, a
credential deletion operation is defined.
Credential providers SHOULD NOT allow automatic deletion of credentials, as
this would allow misbehaving services to delete valid credentials. Financial
institutions are notorious for these kinds of user-hostile policies, and might
attempt to delete valid credentials as a misguided way to "protect" the user.
As such, credential deletion SHOULD require explicit user confirmation.
Where this is done legitimately, such as after a retrieved credential is
discovered to be invalid or a user deletes their account, the request for
confirmation will not be surprising to the user.

### Delete request message

A credential deletion request is represented by the following protocol buffer
message:

```protobuf
message CredentialDeleteRequest {
    ClientVersion client_version = 1;

    // required
    Credential credential = 2;

    map<string, bytes> additional_props = 3;
}
```

### Delete response message

A credential deletion response is represented by the following protocol buffer
message:

```protobuf
message CredentialDeleteResult {
  enum ResultCode {
    UNSPECIFIED = 0;
    BAD_REQUEST = 1;
    DELETED = 2;
    NO_MATCHING_CREDENTIAL = 3;
    PROVIDER_REFUSED = 4;
    USER_CANCELED = 5;
    USER_REFUSED = 6;
  }

  // required
  ResultCode result_code = 1;

  map<string, bytes> additional_props = 2;
}
```

The result codes are defined as follows:

- `UNSPECIFIED`: The generic catch-all for a request failure. This SHOULD NOT
  be used by providers, unless the other defined response codes do not apply.

- `BAD_REQUEST`: The request sent by the client was malformed or violated some
  security constraint enforced by the provider. This error should be treated
  as permanent; repeating the exact same request should result in the same
  error code response.

- `DELETED`: The credential was deleted.

- `NO_MATCHING_CREDENTIAL`: The credential was not deleted, as there was no
  matching credential to delete.

- `PROVIDER_REFUSED`: The provider refused to delete the provided credential,
  due to some policy restriction it is enforcing. For example, a provider
  could refuse to delete a credential from a shared keychain. The client
  SHOULD NOT request to delete this credential again.

- `USER_CANCELED`: The user dismissed the request to delete the credential,
  by either pressing the back button, clicking outside the area of a modal
  dialog, or some other "soft" cancelation that is not an explicit refusal
  to delete the credential. The client MAY request to delete this credential
  again at a later time.

- `USER_REFUSED`: The user explicitly refused to delete the credential,
  by selecting a "do not delete" (or similarly phrased) option in the
  presented UI. The client SHOULD NOT request to delete this credential again.
